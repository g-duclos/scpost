![Logo](inst/extdata/scpost_Logo.png)

***

# **scpost**
An R package for post-processing single-cell RNA-Seq data involving unsupervised clustering, dimensionality reduction, batch correction, sample-cluster composition calculation, pseudobulk differential expression (in progress), and functional annotation (in progress).

This package is designed to process data aggregated by **[scprep](https://github.com/g-duclos/scprep)** and now supports all three output object types: **ExpressionSet**, **Seurat**, and **SingleCellExperiment**.

Data that may be used for testing **scpost** may be accessed via the **[scdata](https://github.com/g-duclos/scdata)** package.

***

## Installation

### Option 1: Install from GitHub
The **scpost** R package can be installed from Github using devtools:
```r
devtools::install_github("g-duclos/scpost")
```

### Option 2: Docker Container
For a containerized environment with R, **scpost**, and all dependencies pre-installed:
```bash
# Clone the repository
git clone https://github.com/g-duclos/scpost.git

# Navigate to directory with cloned 'scpost'
cd scpost

# Build the Docker image
docker build -t scpost .

# Run interactive R session with scpost
docker run -it --rm scpost
```

***

## Documentation

ðŸ“– **[Complete Usage Guide](https://g-duclos.github.io/scpost/articles/vignette_scpost_usage.html)** - Guide demonstrating post-processing workflows for all object types

***

## Getting Started

#### Parameters
Specify the pipeline parameters - view the parameters file here: [scpost_parameters.csv](inst/extdata/scpost_parameters.csv) (click "Raw file" at the top right to download)

**Critical Parameters**
* *dir_input* (path to input directory containing output from scprep)
* *dir_output* (path to output directory)
* *batch_correction_method* (FALSE, "harmony", or "cca")
* *batch_var* (metadata column name for batch variable, or FALSE)
* *pc_max* (maximum number of principal components to use)
* *res_ops* (comma-separated clustering resolution values)

#### Input Directory
Define the input directory (*dir_input*), which must contain one of the following files generated by the **[scprep](https://github.com/g-duclos/scprep)** R package:

**Supported Input Files:**
* **ExpressionSet.rds** (Bioconductor ExpressionSet object with GEX counts + metadata)
* **seurat.rds** (Seurat v5 object with GEX counts + metadata)
* **sce.rds** (SingleCellExperiment object with GEX counts + metadata)

**Note:** The object type is automatically detected based on which file is present in the input directory.

#### Dependencies:
**scpost** requires the following R packages:
- **Seurat** (>= 5.0.0): For single-cell analysis workflows and data processing
- **harmony** (optional): For Harmony batch correction method
- **Biobase**: For ExpressionSet data structures
- **SingleCellExperiment**: For SingleCellExperiment object support
- **SummarizedExperiment**: For SCE data manipulation
- **S4Vectors**: For metadata operations
- **R** (>= 4.0.0): Minimum R version

**Note:** Seurat is NOT included as a formal package dependency due to common installation complications, but must be installed separately. All other dependencies are automatically installed when using `devtools::install_github()`.

***

## Supported Object Types

**scpost** now supports three different input/output object types, maintaining compatibility with data generated by **scprep**:

### **ExpressionSet** (Original)
- Classic Bioconductor S4 object for storing expression data
- Results stored in `assayData$Seurat` and `pData()` slots
- Compatible with traditional Bioconductor workflows

### **Seurat** (v5)
- Popular single-cell analysis object
- Results stored in `@reductions`, `@misc`, and `@meta.data` slots
- Seamlessly integrates with existing Seurat-based pipelines

### **SingleCellExperiment**
- Modern Bioconductor S4 object for single-cell data
- Results stored in `reducedDims()`, `metadata()`, and `colData()` slots
- Compatible with Bioconductor/scater workflows

***

## Overview

Template function to perform unsupervised clustering, dimensionality reduction, batch correction, sample-cluster composition calculation, pseudobulk differential expression (in progress), and functional annotation (in progress).

**Works with all three object types:**
```r
library(Biobase)

# Automatically detects object type and processes accordingly
dataset <- scpost::template_scpost(dir_output=dir_output)
```

**Core functions:**

<details>
	<summary>
		Build or process Seurat object with normalization, highly variable gene selection, scaling, and principal component analysis (PCA).
	</summary>
<pre>
# For ExpressionSet or SingleCellExperiment inputs:
# Select high quality cells
cells <- dataset$ID[which(dataset$Cell_Filter == "Cell")]
</pre>
<pre>
# Select genes with minimum expression requirements (ExpressionSet only)
genes <- Biobase::fData(dataset)$Ensembl[which(fData(dataset)$Gene_Filter == "Expressed")]
</pre>
<pre>
# Build new Seurat object from counts matrix (for ExpressionSet/SCE)
seurat.obj <- scpost::scpost_seurat_init(
    counts=counts[genes, cells],
    pc_max=pc_max,
    verbose=verbose)
</pre>
<pre>
# For Seurat inputs:
# Existing Seurat object is processed directly (normalize â†’ scale â†’ PCA)
# No need to create new object - original object is enriched with results
</pre>
</details>


<details>
	<summary>
		Data integration intended to correct for technical batch effects for downstream clustering & dimensionality reduction, based on a selected "batch" variable of interest using one of the following methods:
		<ul><li>
			<a href="https://github.com/immunogenomics/harmony">Harmony R package</a>
		</li>
		<li>
			<a href="https://satijalab.org/seurat/articles/integration_rpca.html">Seurat's CCA/RPCA method</a>
		</li>
	</summary>
<pre>
# Extract batch metadata from appropriate object type
# For ExpressionSet:
batch_metadata <- Biobase::pData(dataset)[colnames(seurat.obj), batch_var]
# For Seurat:
batch_metadata <- dataset@meta.data[colnames(seurat.obj), batch_var]
# For SingleCellExperiment:
batch_metadata <- SummarizedExperiment::colData(dataset)[colnames(seurat.obj), batch_var]
names(batch_metadata) <- colnames(seurat.obj)
</pre>
<pre>
# Perform batch correction with "harmony" or "cca" method
seurat.obj <- scpost::scpost_batch_correction(
   	seurat.obj=seurat.obj,
    batch_metadata=batch_metadata,
    method=reduction,
    pc_max=pc_max,
    verbose=verbose)
</pre>
</details>

<details>
	<summary>
		A single command to perform unsupervised cell clustering using Seurat's standard methodology (SNN & Louvain community detection) with the option of returning a range of cluster solutions.
	</summary>
<pre>
# Perform unsupervised clustering at specified resolution
seurat.obj <- scpost::scpost_seurat_cluster(
	seurat.obj=seurat.obj,
	pc_max=pc_max,
	resolution=res,
	reduction=reduction,
	seurat_return=TRUE,
	verbose=verbose)
</pre>
</details>


<details>
	<summary>
	The Seurat *RunTSNE* function is used to run t-SNE on the dataset.
	</summary>
	<ul><li>
		tSNE results are stored in object-specific locations:
		<ul>
			<li><strong>ExpressionSet:</strong> assayData$Seurat[["tSNE"]]</li>
			<li><strong>Seurat:</strong> @misc$tSNE_iterations</li>
			<li><strong>SingleCellExperiment:</strong> reducedDim(, "tSNE_Iteration_X")</li>
		</ul>
	</li>
	<li>
		tSNE results will reflect the decision to use or not use one of the specified batch correction methods
	</li>
	<li>
		According to the number of iterations specified in the "scpost_parameters.csv" file, results are subsequently stored as "Iteration_1", "Iteration_2", ...
	</li>
	<li>
		According to the number of iterations specified in the "scpost_parameters.csv" file, results are saved in a subdirectory named "scpost_analysis" in *dir_output* in the RDS format as "tSNE_Iteration_1.rds", "tSNE_Iteration_2.rds", ...
	</li>
	</ul>
</details>


<details>
	<summary>
		The Seurat *RunUMAP* function is used to run UMAP on the dataset.
	</summary>
	<ul><li>
		UMAP results are stored in object-specific locations:
		<ul>
			<li><strong>ExpressionSet:</strong> assayData$Seurat[["UMAP"]]</li>
			<li><strong>Seurat:</strong> @misc$UMAP_iterations</li>
			<li><strong>SingleCellExperiment:</strong> reducedDim(, "UMAP_Iteration_X")</li>
		</ul>
	</li>
	<li>
		UMAP results will reflect the decision to use or not use one of the specified batch correction methods
	</li>
	<li>
		According to the number of iterations specified in the "scpost_parameters.csv" file, results are subsequently stored as "Iteration_1", "Iteration_2", ...
	</li>
	<li>
		According to the number of iterations specified in the "scpost_parameters.csv" file, results are saved in a subdirectory named "scpost_analysis" in *dir_output* in the RDS format as "UMAP_Iteration_1.rds", "UMAP_Iteration_2.rds", ...
	</li>
	</ul>
</details>


<li>
	Sample-cluster composition assessment methods with built-in statistical methods for univariate or multivariate analysis of cluster-associations with variable(s) of interest are a work in progress ...
</li>
<br>


<li>
	Pseudobulk differential expression functionalities, involving the use of the <a href="https://bioconductor.org/packages/release/bioc/html/DESeq2.html">DESeq2 R package</a> are a work in progress...
</li>
<br>


<li>
	Functional annotation, involving the use of gene set databases, including <a href="https://www.gsea-msigdb.org/gsea/msigdb/">the Molecular Signatures Database (MSigDB)</a> and <a href="https://geneontology.org">Gene Ontology (GO)</a>, with methods, including the <a href="https://bioconductor.org/packages/release/bioc/html/fgsea.html">Fast Gene Set Enrichment analysis (fgsea) R package</a> and the <a href="https://cran.r-project.org/web/packages/enrichR/index.html">enrichR R package</a>
</li>
<br>


<details>
	<summary>Additional features</summary>
<ul>
<li>
	Automatically detects input object type (ExpressionSet, Seurat, or SingleCellExperiment) and processes accordingly
</li>

<li>
	Parameters specified in scpost_parameters.csv are stored in object-specific locations:
	<ul>
		<li><strong>ExpressionSet:</strong> assayData$Params[["scpost_Parameters"]]</li>
		<li><strong>Seurat:</strong> @misc$scpost_Parameters</li>
		<li><strong>SingleCellExperiment:</strong> metadata()$scpost_Parameters</li>
	</ul>
</li>

<li>
	Random seeds for reproducible UMAP/tSNE iterations are either retrieved from the input object (if generated by scprep) or automatically generated and stored
</li>

<li>
	Clustering results stored in appropriate metadata slots:
	<ul>
		<li><strong>ExpressionSet:</strong> pData()$Seurat_Clusters_Res-X</li>
		<li><strong>Seurat:</strong> @meta.data$Seurat_Clusters_Res-X</li>
		<li><strong>SingleCellExperiment:</strong> colData()$Seurat_Clusters_Res-X</li>
	</ul>
</li>

<li>
	PCA and batch-corrected embeddings stored in object-specific reduction slots:
	<ul>
		<li><strong>ExpressionSet:</strong> assayData$Seurat[["PCA"]] and assayData$Seurat[["PCA_Harmony"]]</li>
		<li><strong>Seurat:</strong> @reductions$pca and @reductions$harmony</li>
		<li><strong>SingleCellExperiment:</strong> reducedDim(, "PCA") and reducedDim(, "PCA_Harmony")</li>
	</ul>
</li>

<li>
	Output object saved with appropriate filename:
	<ul>
		<li><strong>ExpressionSet:</strong> ExpressionSet.rds</li>
		<li><strong>Seurat:</strong> seurat.rds</li>
		<li><strong>SingleCellExperiment:</strong> sce.rds</li>
	</ul>
</li>

<li>
	All intermediate results (PCA embeddings, clustering metadata, UMAP/tSNE iterations) saved as separate .rds files in scpost_analysis subdirectory for easy downstream access
</li>
</ul>
</details>

***

## Data Flow: scprep â†’ scpost

**scpost** seamlessly integrates with **scprep** output. Example workflow using Seurat objects:

```r
# Step 1: Aggregate data with scprep
scprep::template_scprep(dir_input="/path/to/cellranger", dir_output="/path/to/output")
# Creates: /path/to/output/seurat.rds

# Step 2: Post-process with scpost
scpost::template_scpost(dir_output="/path/to/output")
# Reads: seurat.rds â†’ Processes â†’ Saves: seurat.rds + analysis results
```

**Note:** The same workflow applies to **ExpressionSet** (`ExpressionSet.rds`) and **SingleCellExperiment** (`sce.rds`) objects. The `output_type` parameter is specified in `scprep_parameters.csv` when running **scprep**, and **scpost** automatically detects and processes the corresponding object type.

***
